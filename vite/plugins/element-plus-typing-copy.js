import path from "path";
import fs from "fs/promises";

const dtsHeaderComment = `/* eslint-disable */
/* prettier-ignore */
// @ts-nocheck
// noinspection JSUnusedGlobalSymbols
// Generated by element-plus-typing-copy
`;

/**
 * 复制 dts 文件
 * @param {string} sourcePath 源文件路径
 * @param {string} targetPath 目标文件路径
 * @returns {Promise<void>}
 */
async function copyDTS(sourcePath, targetPath) {
    try {
        await fs.access(sourcePath, fs.constants.R_OK);

        let dtsContent = await fs.readFile(sourcePath, "utf8");
        let outputCode = dtsHeaderComment + dtsContent.replace("@vue/runtime-core", "vue");

        await fs.writeFile(targetPath, outputCode);
    } catch (ignored) {}
}

/**
 * 创建 element-plus-typing-copy 插件
 * @returns {import("vite").PluginOption} vite 插件
 */
export default function createElementPlusTypingCopy() {
    return {
        name: "element-plus-typing-copy",
        enforce: "pre",
        buildStart() {
            let dtsPath = path.resolve(process.cwd(), "./node_modules/element-plus/global.d.ts");
            let targetPath = path.resolve(process.cwd(), "./typing/generated/element-plus-global.d.ts");
            // noinspection JSIgnoredPromiseFromCall
            copyDTS(dtsPath, targetPath);
        },
    };
}
